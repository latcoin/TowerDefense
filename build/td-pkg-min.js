var _TD={a:[],retina:window.devicePixelRatio||1,init:function(a,e){delete this.init;var c,b={version:"0.1.17",is_debug:!!e,is_paused:!0,width:16,height:16,show_monster_life:!0,fps:0,exp_fps:24,exp_fps_half:12,exp_fps_quarter:6,exp_fps_eighth:4,stage_data:{},defaultSettings:function(){return{step_time:36,grid_size:32*_TD.retina,padding:10*_TD.retina,global_speed:.1}},init:function(d){this.obj_board=b.lang.$e(d);this.canvas=this.obj_board.getElementsByTagName("canvas")[0];this.canvas.getContext&&(this.ctx=
this.canvas.getContext("2d"),this.monster_type_count=b.getDefaultMonsterAttributes(),this.iframe=0,this.last_iframe_time=(new Date).getTime(),this.fps=0,this.start())},start:function(){clearTimeout(this._st);b.log("Start!");var d=this;this._exp_fps_0=this.exp_fps-.4;this._exp_fps_1=this.exp_fps+.4;this.mode="normal";this.eventManager.clear();this.lang.mix(this,this.defaultSettings());this.stage=new b.Stage("stage-main",b.getDefaultStageData("stage_main"));this.canvas.setAttribute("width",this.stage.width);
this.canvas.setAttribute("height",this.stage.height);this.canvas.style.width=this.stage.width/_TD.retina+"px";this.canvas.style.height=this.stage.height/_TD.retina+"px";this.canvas.onmousemove=function(b){b=d.getEventXY.call(d,b);d.hover(b[0],b[1])};this.canvas.onclick=function(b){b=d.getEventXY.call(d,b);d.click(b[0],b[1])};this.is_paused=!1;this.stage.start();this.step();return this},checkCheat:function(b){switch(b){case "money+":this.money+=1E6;this.log("cheat success!");break;case "life+":this.life=
100;this.log("cheat success!");break;case "life-":this.life=1;this.log("cheat success!");break;case "difficulty+":this.difficulty*=2;this.log("cheat success! difficulty = "+this.difficulty);break;case "difficulty-":this.difficulty/=2,this.log("cheat success! difficulty = "+this.difficulty)}},step:function(){this.is_debug&&_TD&&_TD.cheat&&(this.checkCheat(_TD.cheat),_TD.cheat="");if(!this.is_paused){this.iframe++;if(0==this.iframe%50){var d=(new Date).getTime(),g=this.step_time;this.fps=Math.round(5E5/
(d-this.last_iframe_time))/10;this.last_iframe_time=d;this.fps<this._exp_fps_0&&1<g?g--:this.fps>this._exp_fps_1&&g++;this.step_time=g}0==this.iframe%2400&&b.gc();this.stage.step();this.stage.render();var a=this;this._st=setTimeout(function(){a.step()},this.step_time)}},getEventXY:function(d){var g=b.lang.$e("wrapper");return[(d.clientX-g.offsetLeft-this.canvas.offsetLeft+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft))*_TD.retina,(d.clientY-g.offsetTop-this.canvas.offsetTop+
Math.max(document.documentElement.scrollTop,document.body.scrollTop))*_TD.retina]},hover:function(b,g){this.eventManager.hover(b,g)},click:function(b,g){this.eventManager.click(b,g)},mouseHand:function(b){this.canvas.style.cursor=b?"pointer":"default"},log:function(b){this.is_debug&&window.console&&console.log&&console.log(b)},gc:function(){window.CollectGarbage&&(CollectGarbage(),setTimeout(CollectGarbage,1))}};for(c=0;this.a[c];c++)this.a[c](b);delete this.a;b.init(a)}};
_TD.a.push(function(a){a.lang={$e:function(a){return document.getElementById(a)},$c:function(a,c,b){a=document.createElement(a);c=c||{};for(var d in c)c.hasOwnProperty(d)&&a.setAttribute(d,c[d]);b&&b.appendChild(a);return a},strLeft:function(a,c){var b=a.slice(0,c),d=b.replace(/[^\x00-\xff]/g,"**").length;if(d<=c)return b;d-=b.length;switch(d){case 0:return b;case c:return a.slice(0,c>>1);default:var b=c-d,d=a.slice(b,c),g=d.replace(/[\x00-\xff]/g,"").length;return g?a.slice(0,b)+this.arguments.callee(d,
g):a.slice(0,b)}},strLen2:function(a){return a.replace(/[^\x00-\xff]/g,"**").length},each:function(a,c){if(Array.prototype.forEach)a.forEach(c);else for(var b=0,d=a.length;b<d;b++)c(a[b])},any:function(a,c){for(var b=0,d=a.length;b<d;b++)if(c(a[b]))return a[b];return null},shift:function(a,c){for(;a[0];)c(a.shift())},rndSort:function(a){return a.concat().sort(function(){return Math.random()-.5})},_rndRGB2:function(a){a=a.toString(16);return 2==a.length?a:"0"+a},rndRGB:function(){var a=Math.floor(256*
Math.random()),c=Math.floor(256*Math.random());return"#"+this._rndRGB2(Math.floor(256*Math.random()))+this._rndRGB2(a)+this._rndRGB2(c)},rgb2Arr:function(a){if(7!=a.length)return[0,0,0];var c=a.substr(1,2),b=a.substr(3,2);a=a.substr(3,2);return[parseInt(c,16),parseInt(b,16),parseInt(a,16)]},rndStr:function(a){a=a||16;var c=[],b,d;for(b=0;b<a;b++)d=Math.floor(36*Math.random()),c.push("1234567890abcdefghijklmnopqrstuvwxyz".substr(d,1));return c.join("")},nullFunc:function(){},arrayEqual:function(a,
c){var b,d=a.length;if(d!=c.length)return!1;for(b=0;b<d;b++)if(a[b]!=c[b])return!1;return!0},mix:function(a,c,b){if(!c||!a)return a;for(var d in c)!c.hasOwnProperty(d)||!1===b&&d in a||(a[d]=c[d]);return a}}});
_TD.a.push(function(a){a.eventManager={ex:-1,ey:-1,_registers:{},ontypes:["enter","hover","out","click"],current_type:"hover",isOn:function(a){return-1!=this.ex&&-1!=this.ey&&this.ex>a.x&&this.ex<a.x2&&this.ey>a.y&&this.ey<a.y2},_mkElEvtName:function(a,c){return a.id+"::_evt_::"+c},on:function(a,c,b){this._registers[this._mkElEvtName(a,c)]=[a,c,b]},removeEventListener:function(a,c){var b=this._mkElEvtName(a,c);delete this._registers[b]},clear:function(){delete this._registers;this._registers={}},
step:function(){if(this.current_type){var e,c,b,d,g,h=this,f=this.ontypes.length,k,l=[];for(e in this._registers)this._registers.hasOwnProperty(e)&&((c=this._registers[e],b=c[0],d=c[1],c=c[2],b.is_valid)?b.is_visiable&&(k=this.isOn(b),"click"!=this.current_type?"hover"==d&&b.is_hover&&k?(c(),this.current_type="hover"):"enter"==d&&!b.is_hover&&k?(b.is_hover=!0,c(),this.current_type="enter"):"out"==d&&b.is_hover&&!k&&(b.is_hover=!1,c(),this.current_type="out"):k&&"click"==d&&c()):l.push(b));a.lang.each(l,
function(b){for(g=0;g<f;g++)h.removeEventListener(b,h.ontypes[g])});this.current_type=""}},hover:function(a,c){"click"!=this.current_type&&(this.current_type="hover",this.ex=a,this.ey=c)},click:function(a,c){this.current_type="click";this.ex=a;this.ey=c}}});
_TD.a.push(function(a){a.Stage=function(e,c){this.id=e||"stage-"+a.lang.rndStr();this.cfg=c||{};this.width=this.cfg.width||640;this.height=this.cfg.height||540;this.mode="normal";this.state=0;this.acts=[];this.current_act=null;this._step2=a.lang.nullFunc;this._init()};a.Stage.prototype={_init:function(){"function"==typeof this.cfg.init&&this.cfg.init.call(this);"function"==typeof this.cfg.step2&&(this._step2=this.cfg.step2)},start:function(){this.state=1;a.lang.each(this.acts,function(a){a.start()})},
pause:function(){this.state=2},gameover:function(){this.current_act.gameover()},clear:function(){this.state=3;a.lang.each(this.acts,function(a){a.clear()})},step:function(){1==this.state&&this.current_act&&(a.eventManager.step(),this.current_act.step(),this._step2())},render:function(){0!=this.state&&3!=this.state&&this.current_act&&this.current_act.render()},addAct:function(a){this.acts.push(a)},addElement:function(a,c,b){this.current_act&&this.current_act.addElement(a,c,b)}}});
_TD.a.push(function(a){a.Act=function(e,c){this.stage=e;this.id=c||"act-"+a.lang.rndStr();this.state=0;this.scenes=[];this.end_queue=[];this.current_scene=null;this._init()};a.Act.prototype={_init:function(){this.stage.addAct(this)},start:function(){this.stage.current_act&&3!=this.stage.current_act.state?(this.state=0,this.stage.current_act.queue(this.start)):(this.state=1,this.stage.current_act=this,a.lang.each(this.scenes,function(a){a.start()}))},pause:function(){this.state=2},end:function(){this.state=
3;for(var a;a=this.end_queue.shift();)a();this.stage.current_act=null},queue:function(a){this.end_queue.push(a)},clear:function(){this.state=3;a.lang.each(this.scenes,function(a){a.clear()})},step:function(){1==this.state&&this.current_scene&&this.current_scene.step()},render:function(){0!=this.state&&3!=this.state&&this.current_scene&&this.current_scene.render()},addScene:function(a){this.scenes.push(a)},addElement:function(a,c,b){this.current_scene&&this.current_scene.addElement(a,c,b)},gameover:function(){this.current_scene.gameover()}}});
_TD.a.push(function(a){a.Scene=function(e,c){this.act=e;this.stage=e.stage;this.is_gameover=!1;this.id=c||"scene-"+a.lang.rndStr();this.state=0;this.end_queue=[];this._step_elements=[[],[],[]];this._render_elements=[[],[],[],[],[],[],[],[],[],[]];this._init()};a.Scene.prototype={_init:function(){this.act.addScene(this);this.wave=0},start:function(){this.act.current_scene&&this.act.current_scene!=this&&3!=this.act.current_scene.state?(this.state=0,this.act.current_scene.queue(this.start)):(this.state=
1,this.act.current_scene=this)},pause:function(){this.state=2},end:function(){this.state=3;for(var a;a=this.end_queue.shift();)a();this.clear();this.act.current_scene=null},clear:function(){a.lang.shift(this._step_elements,function(e){a.lang.shift(e,function(a){a.del()})});a.lang.shift(this._render_elements,function(e){a.lang.shift(e,function(a){a.del()})})},queue:function(a){this.end_queue.push(a)},gameover:function(){this.is_gameover||(this.pause(),this.is_gameover=!0)},step:function(){if(1==this.state){0>=
a.life&&(a.life=0,this.gameover());var e,c;for(e=0;3>e;e++)c=[],a.lang.shift(this._step_elements[e],function(b){b.is_valid?(b.is_paused||b.step(),c.push(b)):setTimeout(function(){b=null},500)}),this._step_elements[e]=c}},render:function(){if(0!=this.state&&3!=this.state){var e,c;a.ctx.clearRect(0,0,this.stage.width,this.stage.height);for(e=0;10>e;e++)c=[],a.lang.shift(this._render_elements[e],function(b){b.is_valid&&(b.is_visiable&&b.render(),c.push(b))}),this._render_elements[e]=c;this.is_gameover&&
this.panel.gameover_obj.show()}},addElement:function(a,c,b){c=c||a.step_level||1;b=b||a.render_level;this._step_elements[c].push(a);this._render_elements[b].push(a);a.scene=this;a.step_level=c;a.render_level=b}}});
_TD.a.push(function(a){a.Element=function(e,c){this.id=e||"el-"+a.lang.rndStr();this.cfg=c||{};this.is_valid=!0;this.is_visiable="undefined"!=typeof c.is_visiable?c.is_visiable:!0;this.is_hover=this.is_paused=!1;this.x=this.cfg.x||-1;this.y=this.cfg.y||-1;this.width=this.cfg.width||0;this.height=this.cfg.height||0;this.step_level=c.step_level||1;this.render_level=c.render_level;this.on_events=c.on_events||[];this._init()};a.Element.prototype={_init:function(){var a=this,c,b,d;c=0;for(d=this.on_events.length;c<
d;c++)switch(b=this.on_events[c],b){case "enter":this.on("enter",function(){a.onEnter()});break;case "out":this.on("out",function(){a.onOut()});break;case "hover":this.on("hover",function(){a.onHover()});break;case "click":this.on("click",function(){a.onClick()})}this.caculatePos()},caculatePos:function(){this.cx=this.x+this.width/2;this.cy=this.y+this.height/2;this.x2=this.x+this.width;this.y2=this.y+this.height},start:function(){this.is_paused=!1},pause:function(){this.is_paused=!0},hide:function(){this.is_visiable=
!1;this.onOut()},show:function(){this.is_visiable=!0},del:function(){this.is_valid=!1},on:function(e,c){a.eventManager.on(this,e,c)},onEnter:a.lang.nullFunc,onOut:a.lang.nullFunc,onHover:a.lang.nullFunc,onClick:a.lang.nullFunc,step:a.lang.nullFunc,render:a.lang.nullFunc,addToScene:function(e,c,b,d){this.scene=e;isNaN(c)||(this.step_level=c||this.step_level,this.render_level=b||this.render_level,d&&a.lang.each(d,function(a){e.addElement(a,c,b)}),e.addElement(this,c,b))}}});
_TD.a.push(function(a){function e(b,c){var f=new a.Element(b,c);a.lang.mix(f,d);f._init(c);return f}var c={_init:function(b){b=b||{};this.grid_x=b.grid_x||10;this.grid_y=b.grid_y||10;this.x=b.x||0;this.y=b.y||0;this.width=this.grid_x*a.grid_size;this.height=this.grid_y*a.grid_size;this.x2=this.x+this.width;this.y2=this.y+this.width;this.grids=[];this.entrance=this.exit=null;this.buildings=[];this.monsters=[];this.bullets=[];this.scene=b.scene;this.is_main_map=!!b.is_main_map;this.select_hl=a.MapSelectHighLight(this.id+
"-hl",{map:this});this.select_hl.addToScene(this.scene,1,9);this.selected_building=null;this._wait_clearInvalidElements=20;this._wait_add_monsters=0;this._wait_add_monsters_arr=[];this.is_main_map&&(this.mmm=new e(this.id+"-mmm",{map:this}),this.mmm.addToScene(this.scene,1,7));var d,c=this.grid_x*this.grid_y,k=b.grid_data||[],l;for(d=0;d<c;d++)l=k[d]||{},l.mx=d%this.grid_x,l.my=Math.floor(d/this.grid_x),l.map=this,l.step_level=this.step_level,l.render_level=this.render_level,l=new a.Grid(this.id+
"-grid-"+l.mx+"-"+l.my,l),this.grids.push(l);b.entrance&&b.exit&&!a.lang.arrayEqual(b.entrance,b.exit)&&(this.entrance=this.getGrid(b.entrance[0],b.entrance[1]),this.entrance.is_entrance=!0,this.exit=this.getGrid(b.exit[0],b.exit[1]),this.exit.is_exit=!0);var m=this;b.grids_cfg&&a.lang.each(b.grids_cfg,function(b){var a=m.getGrid(b.pos[0],b.pos[1]);a&&(isNaN(b.passable_flag)||(a.passable_flag=b.passable_flag),isNaN(b.build_flag)||(a.build_flag=b.build_flag),b.building&&a.addBuilding(b.building))})},
checkHasWeapon:function(){this.has_weapon=null!=this.anyBuilding(function(b){return b.is_weapon})},getGrid:function(b,a){return this.grids[a*this.grid_x+b]},anyMonster:function(b){return a.lang.any(this.monsters,b)},anyBuilding:function(b){return a.lang.any(this.buildings,b)},anyBullet:function(b){return a.lang.any(this.bullets,b)},eachBuilding:function(b){a.lang.each(this.buildings,b)},eachMonster:function(b){a.lang.each(this.monsters,b)},eachBullet:function(b){a.lang.each(this.bullets,b)},preBuild:function(b){a.mode=
"build";this.pre_building&&this.pre_building.remove();this.pre_building=new a.Building(this.id+"-pre-building-"+a.lang.rndStr(),{type:b,map:this,is_pre_building:!0});this.scene.addElement(this.pre_building,1,this.render_level+1)},cancelPreBuild:function(){a.mode="normal";this.pre_building&&this.pre_building.remove()},clearInvalidElements:function(){if(0<this._wait_clearInvalidElements)this._wait_clearInvalidElements--;else{this._wait_clearInvalidElements=20;var b=[];a.lang.shift(this.buildings,function(a){a.is_valid&&
b.push(a)});this.buildings=b;b=[];a.lang.shift(this.monsters,function(a){a.is_valid&&b.push(a)});this.monsters=b;b=[];a.lang.shift(this.bullets,function(a){a.is_valid&&b.push(a)});this.bullets=b}},addMonster:function(b){this.entrance&&("number"==typeof b&&(b=new a.Monster(null,{idx:b,difficulty:a.difficulty,step_level:this.step_level,render_level:this.render_level+2})),this.entrance.addMonster(b))},addMonsters:function(b,a){this._wait_add_monsters=b;this._wait_add_monsters_objidx=a},addMonsters2:function(b){this._wait_add_monsters_arr=
b},checkPassable:function(b,a){var d=this.getGrid(b,a);return null!=d&&1==d.passable_flag&&2!=d.build_flag},step:function(){this.clearInvalidElements();if(0<this._wait_add_monsters)this.addMonster(this._wait_add_monsters_objidx),this._wait_add_monsters--;else if(0<this._wait_add_monsters_arr.length){var b=this._wait_add_monsters_arr.shift();this.addMonsters(b[0],b[1])}},render:function(){var b=a.ctx;b.strokeStyle="#99a";b.lineWidth=_TD.retina;b.beginPath();b.strokeRect(this.x+.5,this.y+.5,this.width,
this.height);b.closePath();b.stroke()},onOut:function(){this.is_main_map&&this.pre_building&&this.pre_building.hide()}};a.Map=function(b,d){d.on_events=["enter","out"];var f=new a.Element(b,d);a.lang.mix(f,c);f._init(d);return f};var b={_init:function(b){this.map=b.map;this.width=a.grid_size+2;this.height=a.grid_size+2;this.is_visiable=!1},show:function(b){this.x=b.x;this.y=b.y;this.is_visiable=!0},render:function(){var b=a.ctx;b.lineWidth=2;b.strokeStyle="#f93";b.beginPath();b.strokeRect(this.x,
this.y,this.width-1,this.height-1);b.closePath();b.stroke()}};a.MapSelectHighLight=function(d,c){var f=new a.Element(d,c);a.lang.mix(f,b);f._init(c);return f};var d={_init:function(b){this.map=b.map;this.x1=this.map.x;this.y1=this.map.y;this.x2=this.map.x2+1;this.y2=this.map.y2+1;this.w=this.map.scene.stage.width;this.h=this.map.scene.stage.height;this.w2=this.w-this.x2;this.h2=this.h-this.y2},render:function(){var b=a.ctx;b.fillStyle="#fff";b.beginPath();b.fillRect(0,0,this.x1,this.h);b.fillRect(0,
0,this.w,this.y1);b.fillRect(0,this.y2,this.w,this.h2);b.fillRect(this.x2,0,this.w2,this.h);b.closePath();b.fill()}}});
_TD.a.push(function(a){var e={_init:function(c){c=c||{};this.map=c.map;this.scene=this.map.scene;this.mx=c.mx;this.my=c.my;this.height=this.width=a.grid_size;this.is_entrance=this.is_exit=!1;this.build_flag=this.passable_flag=1;this.building=null;this.caculatePos()},caculatePos:function(){this.x=this.map.x+this.mx*a.grid_size;this.y=this.map.y+this.my*a.grid_size;this.x2=this.x+a.grid_size;this.y2=this.y+a.grid_size;this.cx=Math.floor(this.x+a.grid_size/2);this.cy=Math.floor(this.y+a.grid_size/2)},
checkBlock:function(){if(this.is_entrance||this.is_exit)return this._block_msg=a._t("entrance_or_exit_be_blocked"),!0;var c,b=this;if(c=(new a.FindWay(this.map.grid_x,this.map.grid_y,this.map.entrance.mx,this.map.entrance.my,this.map.exit.mx,this.map.exit.my,function(a,c){return!(a==b.mx&&c==b.my)&&b.map.checkPassable(a,c)})).is_blocked)this._block_msg=a._t("blocked");else if(c=!!this.map.anyMonster(function(a){return a.chkIfBlocked(b.mx,b.my)}))this._block_msg=a._t("monster_be_blocked");return c},
buyBuilding:function(c){var b=a.getDefaultBuildingAttributes(c).cost||0;a.money>=b?(a.money-=b,this.addBuilding(c)):(a.log(a._t("not_enough_money",[b])),this.scene.panel.balloontip.msg(a._t("not_enough_money",[b]),this))},addBuilding:function(c){this.building&&this.removeBuilding();c=new a.Building("building-"+c+"-"+a.lang.rndStr(),{type:c,step_level:this.step_level,render_level:this.render_level});c.locate(this);this.scene.addElement(c,this.step_level,this.render_level+1);this.map.buildings.push(c);
this.building=c;this.build_flag=2;this.map.checkHasWeapon();this.map.pre_building&&this.map.pre_building.hide()},removeBuilding:function(){2==this.build_flag&&(this.build_flag=1);this.building&&this.building.remove();this.building=null},addMonster:function(a){a.beAddToGrid(this);this.map.monsters.push(a);a.start()},hightLight:function(a){this.map.select_hl[a?"show":"hide"](this)},render:function(){var c=a.ctx,b=this.x+.5,d=this.y+.5;this.is_hover&&(c.fillStyle="rgba(255, 255, 200, 0.2)",c.beginPath(),
c.fillRect(b,d,this.width,this.height),c.closePath(),c.fill());0==this.passable_flag&&(c.fillStyle="#fcc",c.beginPath(),c.fillRect(b,d,this.width,this.height),c.closePath(),c.fill());if(this.is_entrance||this.is_exit)c.lineWidth=1,c.fillStyle="#ccc",c.beginPath(),c.fillRect(b,d,this.width,this.height),c.closePath(),c.fill(),c.strokeStyle="#666",c.fillStyle=this.is_entrance?"#fff":"#666",c.beginPath(),c.arc(this.cx,this.cy,.325*a.grid_size,0,2*Math.PI,!0),c.closePath(),c.fill(),c.stroke();c.strokeStyle=
"#eee";c.lineWidth=1;c.beginPath();c.strokeRect(b,d,this.width,this.height);c.closePath();c.stroke()},onEnter:function(){if(this.map.is_main_map&&"build"==a.mode)1==this.build_flag?(this.map.pre_building.show(),this.map.pre_building.locate(this)):this.map.pre_building.hide();else if(this.map.is_main_map){var c="";this.is_entrance?c=a._t("entrance"):this.is_exit?c=a._t("exit"):0==this.passable_flag?c=a._t("_cant_pass"):0==this.build_flag&&(c=a._t("_cant_build"));c&&this.scene.panel.balloontip.msg(c,
this)}},onOut:function(){this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},onClick:function(){1==this.scene.state&&("build"==a.mode&&this.map.is_main_map&&!this.building?this.checkBlock()?this.scene.panel.balloontip.msg(this._block_msg,this):this.buyBuilding(this.map.pre_building.type):!this.building&&this.map.selected_building&&(this.map.selected_building.toggleSelected(),this.map.selected_building=null))}};a.Grid=function(c,b){b.on_events=["enter","out","click"];var d=new a.Element(c,
b);a.lang.mix(d,e);d._init(b);return d}});
_TD.a.push(function(a){var e={_init:function(b){this.is_selected=!1;this.killed=this.level=0;this.target=null;b=b||{};this.map=b.map||null;this.grid=b.grid||null;this.bullet_type=b.bullet_type||1;this.type=b.type;this.speed=b.speed;this.bullet_speed=b.bullet_speed;this.blink=this.is_pre_building=!!b.is_pre_building;this.wait_blink=this._default_wait_blink=20;this.is_weapon="wall"!=this.type;b=a.getDefaultBuildingAttributes(this.type);a.lang.mix(this,b);this.range_px=this.range*a.grid_size;this.money=
this.cost;this.caculatePos()},getUpgradeCost:function(){return Math.floor(.75*this.money)},getSellMoney:function(){return Math.floor(.5*this.money)||1},toggleSelected:function(){this.is_selected=!this.is_selected;this.grid.hightLight(this.is_selected);var b=this;this.is_selected?(this.map.eachBuilding(function(a){a.is_selected=a==b}),(this.map.is_main_map?this.scene.panel_map:this.scene.map).eachBuilding(function(b){b.is_selected=!1;b.grid.hightLight(!1)}),this.map.selected_building=this,this.map.is_main_map?
this.scene.map.cancelPreBuild():this.scene.map.preBuild(this.type)):(this.map.selected_building==this&&(this.map.selected_building=null),this.map.is_main_map||this.scene.map.cancelPreBuild());this.map.is_main_map&&(this.map.selected_building?(this.scene.panel.btn_upgrade.show(),this.scene.panel.btn_sell.show(),this.updateBtnDesc()):(this.scene.panel.btn_upgrade.hide(),this.scene.panel.btn_sell.hide()))},updateBtnDesc:function(){this.scene.panel.btn_upgrade.desc=a._t("upgrade",[a._t("building_name_"+
this.type),this.level+1,this.getUpgradeCost()]);this.scene.panel.btn_sell.desc=a._t("sell",[a._t("building_name_"+this.type),this.getSellMoney()])},locate:function(b){this.grid=b;this.map=b.map;this.cx=this.grid.cx;this.cy=this.grid.cy;this.x=this.grid.x;this.y=this.grid.y;this.x2=this.grid.x2;this.y2=this.grid.y2;this.width=this.grid.width;this.height=this.grid.height;this.px=this.x+.5;this.py=this.y+.5;this.wait_blink=this._default_wait_blink;this._fire_wait2=this._fire_wait=Math.floor(Math.max(2/
(this.speed*a.global_speed),1))},remove:function(){this.grid&&this.grid.building&&this.grid.building==this&&(this.grid.building=null);this.hide();this.del()},findTaget:function(){if(this.is_weapon&&!this.is_pre_building&&this.grid){var b=this.cx,d=this.cy,c=Math.pow(this.range_px,2);this.target&&this.target.is_valid&&Math.pow(this.target.cx-b,2)+Math.pow(this.target.cy-d,2)<=c||(this.target=a.lang.any(a.lang.rndSort(this.map.monsters),function(a){return Math.pow(a.cx-b,2)+Math.pow(a.cy-d,2)<=c}))}},
getTargetPosition:function(){if(!this.target){var b=this.map.is_main_map?this.map.entrance:this.grid;return[b.cx,b.cy]}return[this.target.cx,this.target.cy]},fire:function(){if(this.target&&this.target.is_valid)if("laser_gun"==this.type)this.target.beHit(this,this.damage);else{var b=this.muzzle||[this.cx,this.cy];new a.Bullet(null,{building:this,damage:this.damage,target:this.target,speed:this.bullet_speed,x:b[0],y:b[1]})}},tryToFire:function(){this.is_weapon&&this.target&&(this._fire_wait--,0<this._fire_wait||
(0>this._fire_wait?this._fire_wait=this._fire_wait2:this.fire()))},_upgrade2:function(b){this._upgrade_records[b]||(this._upgrade_records[b]=this[b]);var d=this._upgrade_records[b],c="max_"+b,e=this["_upgrade_rule_"+b]||a.default_upgrade_rule;d&&!isNaN(d)&&(d=e(this.level,d),this[c]&&!isNaN(this[c])&&this[c]<d&&(d=this[c]),this._upgrade_records[b]=d,this[b]=Math.floor(d))},upgrade:function(){this._upgrade_records||(this._upgrade_records={});var b=["damage","range","speed","life","shield"],d,c=b.length;
for(d=0;d<c;d++)this._upgrade2(b[d]);this.level++;this.range_px=this.range*a.grid_size},tryToUpgrade:function(b){var d=this.getUpgradeCost(),c="";d>a.money?c=a._t("not_enough_money",[d]):(a.money-=d,this.money+=d,this.upgrade(),c=a._t("upgrade_success",[a._t("building_name_"+this.type),this.level,this.getUpgradeCost()]));this.updateBtnDesc();this.scene.panel.balloontip.msg(c,b)},tryToSell:function(){this.is_valid&&(a.money+=this.getSellMoney(),this.grid.removeBuilding(),this.is_valid=!1,this.map.selected_building=
null,this.map.select_hl.hide(),this.map.checkHasWeapon(),this.scene.panel.btn_upgrade.hide(),this.scene.panel.btn_sell.hide(),this.scene.panel.balloontip.hide())},step:function(){this.blink&&(this.wait_blink--,this.wait_blink<-this._default_wait_blink&&(this.wait_blink=this._default_wait_blink));this.findTaget();this.tryToFire()},render:function(){if(this.is_visiable&&!(0>this.wait_blink)){var b=a.ctx;a.renderBuilding(this);this.map.is_main_map&&(this.is_selected||this.is_pre_building||this.map.show_all_ranges)&&
this.is_weapon&&0<this.range&&this.grid&&(b.lineWidth=_TD.retina,b.fillStyle="rgba(187, 141, 32, 0.15)",b.strokeStyle="#bb8d20",b.beginPath(),b.arc(this.cx,this.cy,this.range_px,0,2*Math.PI,!0),b.closePath(),b.fill(),b.stroke());"laser_gun"==this.type&&this.target&&this.target.is_valid&&(b.lineWidth=3*_TD.retina,b.strokeStyle="rgba(50, 50, 200, 0.5)",b.beginPath(),b.moveTo(this.cx,this.cy),b.lineTo(this.target.cx,this.target.cy),b.closePath(),b.stroke(),b.lineWidth=_TD.retina,b.strokeStyle="rgba(150, 150, 255, 0.5)",
b.beginPath(),b.lineTo(this.cx,this.cy),b.closePath(),b.stroke())}},onEnter:function(){if(!this.is_pre_building){var b="\u5efa\u7b51\u5de5\u4e8b",b=this.map.is_main_map?a._t("building_info"+("wall"==this.type?"_wall":""),[a._t("building_name_"+this.type),this.level,this.damage,this.speed,this.range,this.killed]):a._t("building_intro_"+this.type,[a.getDefaultBuildingAttributes(this.type).cost]);this.scene.panel.balloontip.msg(b,this.grid)}},onOut:function(){this.scene.panel.balloontip.el==this.grid&&
this.scene.panel.balloontip.hide()},onClick:function(){this.is_pre_building||1!=this.scene.state||this.toggleSelected()}};a.Building=function(b,d){d.on_events=["enter","out","click"];var c=new a.Element(b,d);a.lang.mix(c,e);c._init(d);return c};var c={_init:function(b){b=b||{};this.speed=b.speed;this.damage=b.damage;this.target=b.target;this.cx=b.x;this.cy=b.y;this.r=b.r||Math.max(Math.log(this.damage),2);1>this.r&&(this.r=1);6<this.r&&(this.r=6);this.building=b.building||null;this.map=b.map||this.building.map;
this.type=b.type||1;this.color=b.color||"#000";this.map.bullets.push(this);this.addToScene(this.map.scene,1,6);1==this.type&&this.caculate()},caculate:function(){var b,d,c;d=this.target.cy;var e;b=this.target.cx-this.cx;d-=this.cy;c=Math.sqrt(Math.pow(b,2)+Math.pow(d,2));e=20*this.speed*a.global_speed;this.vx=b*e/c;this.vy=d*e/c},checkOutOfMap:function(){this.is_valid=!(this.cx<this.map.x||this.cx>this.map.x2||this.cy<this.map.y||this.cy>this.map.y2);return!this.is_valid},checkHit:function(){var b=
this.cx,d=this.cy,c=this.r*_TD.retina,e=this.map.anyMonster(function(a){return Math.pow(a.cx-b,2)+Math.pow(a.cy-d,2)<=2*Math.pow(a.r+c,2)});return e?(e.beHit(this.building,this.damage),this.is_valid=!1,a.Explode(this.id+"-explode",{cx:this.cx,cy:this.cy,r:this.r,step_level:this.step_level,render_level:this.render_level,color:this.color,scene:this.map.scene,time:.2}),!0):!1},step:function(){this.checkOutOfMap()||this.checkHit()||(this.cx+=this.vx,this.cy+=this.vy)},render:function(){var b=a.ctx;b.fillStyle=
this.color;b.beginPath();b.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0);b.closePath();b.fill()}};a.Bullet=function(b,d){var g=new a.Element(b,d);a.lang.mix(g,c);g._init(d);return g}});
_TD.a.push(function(a){var e={_init:function(b){b=b||{};this.is_monster=!0;this.idx=b.idx||1;this.difficulty=b.difficulty||1;var d=a.getDefaultMonsterAttributes(this.idx);this.speed=Math.floor((d.speed+this.difficulty/2)*(.5*Math.random()+.75));1>this.speed&&(this.speed=1);this.speed>b.max_speed&&(this.speed=b.max_speed);this.life=this.life0=Math.floor(d.life*(this.difficulty+1)*(Math.random()+.5)*.5);1>this.life&&(this.life=this.life0=1);this.shield=Math.floor(d.shield+this.difficulty/2);0>this.shield&&
(this.shield=0);this.damage=Math.floor((d.damage||1)*(.5*Math.random()+.75));1>this.damage&&(this.damage=1);this.money=d.money||Math.floor(Math.sqrt((this.speed+this.life)*(this.shield+1)*this.damage));1>this.money&&(this.money=1);this.color=d.color||a.lang.rndRGB();this.r=Math.floor(1.2*this.damage)*_TD.retina;this.r<4*_TD.retina&&(this.r=4*_TD.retina);this.r>a.grid_size/2-4*_TD.retina&&(this.r=a.grid_size/2-4*_TD.retina);this.render=d.render;this.next_grid=this.map=this.grid=null;this.way=[];this.toward=
2;this._dy=this._dx=0;this.is_blocked=!1},caculatePos:function(){var b=this.r;this.x=this.cx-b;this.y=this.cy-b;this.x2=this.cx+b;this.y2=this.cy+b},beHit:function(b,d){if(this.is_valid){var c=Math.ceil(.1*d);d-=this.shield;d<=c&&(d=c);this.life-=d;a.score+=Math.floor(Math.sqrt(d));0>=this.life&&this.beKilled(b);c=this.scene.panel.balloontip;c.el==this&&(c.text=a._t("monster_info",[this.life,this.shield,this.speed,this.damage]))}},beKilled:function(b){this.is_valid&&(this.life=0,this.is_valid=!1,
a.money+=this.money,b.killed++,a.Explode(this.id+"-explode",{cx:this.cx,cy:this.cy,color:this.color,r:this.r,step_level:this.step_level,render_level:this.render_level,scene:this.grid.scene}))},arrive:function(){this.grid=this.next_grid;this.next_grid=null;this.checkFinish()},findWay:function(){var b=this;this.way=(new a.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(a,c){return b.map.checkPassable(a,c)})).way},checkFinish:function(){this.grid&&
this.map&&this.grid==this.map.exit&&(a.life-=this.damage,a.wave_damage+=this.damage,0>=a.life?(a.life=0,a.stage.gameover()):(this.pause(),this.del()))},beAddToGrid:function(b){this.grid=b;this.map=b.map;this.cx=b.cx;this.cy=b.cy;this.grid.scene.addElement(this)},getToward:function(){this.grid&&this.next_grid&&(this.grid.my<this.next_grid.my?this.toward=0:this.grid.mx<this.next_grid.mx?this.toward=1:this.grid.my>this.next_grid.my?this.toward=2:this.grid.mx>this.next_grid.mx&&(this.toward=3))},getNextGrid:function(){(0==
this.way.length||.1>Math.random())&&this.findWay();var b=this.way.shift();b&&!this.map.checkPassable(b[0],b[1])&&(this.findWay(),b=this.way.shift());b&&(this.next_grid=this.map.getGrid(b[0],b[1]))},chkIfBlocked:function(b,d){var c=this;return(new a.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(a,f){return!(a==b&&f==d)&&c.map.checkPassable(a,f)})).is_blocked},beBlocked:function(){this.is_blocked||(this.is_blocked=!0,a.log("monster be blocked!"))},
step:function(){if(this.is_valid&&!this.is_paused&&this.grid){if(!this.next_grid&&(this.getNextGrid(),!this.next_grid)){this.beBlocked();return}if(this.cx==this.next_grid.cx&&this.cy==this.next_grid.cy)this.arrive();else{var b=this.next_grid.cx-this.cx,d=this.next_grid.cy-this.cy,c=0>b?-1:1,e=0>d?-1:1,f=this.speed*a.global_speed;Math.abs(b)<f&&Math.abs(d)<f?(this.cx=this.next_grid.cx,this.cy=this.next_grid.cy,this._dx=f-Math.abs(b),this._dy=f-Math.abs(d)):(this.cx+=0==b?0:c*(f+this._dx),this.cy+=
0==d?0:e*(f+this._dy),this._dy=this._dx=0)}this.caculatePos()}},onEnter:function(){var b,d=this.scene.panel.balloontip;d.el==this?(d.hide(),d.el=null):(b=a._t("monster_info",[this.life,this.shield,this.speed,this.damage]),d.msg(b,this))},onOut:function(){}};a.Monster=function(b,d){d.on_events=["enter","out"];var c=new a.Element(b,d);a.lang.mix(c,e);c._init(d);return c};var c={_init:function(b){b=b||{};var d=a.lang.rgb2Arr(b.color);this.cx=b.cx;this.cy=b.cy;this.r=b.r*_TD.retina;this.step_level=b.step_level;
this.render_level=b.render_level;this.rgb_r=d[0];this.rgb_g=d[1];this.rgb_b=d[2];this.rgb_a=1;this.wait=this.wait0=a.exp_fps*(b.time||1);b.scene.addElement(this)},step:function(){this.is_valid&&(this.wait--,this.r++,this.is_valid=0<this.wait,this.rgb_a=this.wait/this.wait0)},render:function(){var b=a.ctx;b.fillStyle="rgba("+this.rgb_r+","+this.rgb_g+","+this.rgb_b+","+this.rgb_a+")";b.beginPath();b.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0);b.closePath();b.fill()}};a.Explode=function(b,d){var g=new a.Element(b,
d);a.lang.mix(g,c);g._init(d);return g}});
_TD.a.push(function(a){var e={_init:function(b){b=b||{};this.x=b.x;this.y=b.y;this.scene=b.scene;this.map=b.main_map;b=new a.Map("panel-map",a.lang.mix({x:this.x+b.map.x,y:this.y+b.map.y,scene:this.scene,step_level:this.step_level,render_level:this.render_level},b.map,!1));this.addToScene(this.scene,1,7);b.addToScene(this.scene,1,7,b.grids);this.scene.panel_map=b;this.gameover_obj=new a.GameOver("panel-gameover",{panel:this,scene:this.scene,step_level:this.step_level,is_visiable:!1,x:0,y:0,width:this.scene.stage.width,
height:this.scene.stage.height,render_level:9});this.balloontip=new a.BalloonTip("panel-balloon-tip",{scene:this.scene,step_level:this.step_level,render_level:9});this.balloontip.addToScene(this.scene,1,9);this.btn_pause=new a.Button("panel-btn-pause",{scene:this.scene,x:this.x,y:this.y+260*_TD.retina,text:a._t("button_pause_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){1==this.scene.state?(this.scene.pause(),this.text=a._t("button_continue_text"),this.scene.panel.btn_upgrade.hide(),
this.scene.panel.btn_sell.hide(),this.scene.panel.btn_restart.show()):2==this.scene.state&&(this.scene.start(),this.text=a._t("button_pause_text"),this.scene.panel.btn_restart.hide(),this.scene.map.selected_building&&(this.scene.panel.btn_upgrade.show(),this.scene.panel.btn_sell.show()))}});this.btn_restart=new a.Button("panel-btn-restart",{scene:this.scene,x:this.x,y:this.y+300*_TD.retina,is_visiable:!1,text:a._t("button_restart_text"),step_level:this.step_level,render_level:this.render_level+1,
onClick:function(){setTimeout(function(){a.stage.clear();a.is_paused=!0;a.start();a.mouseHand(!1)},0)}});this.btn_upgrade=new a.Button("panel-btn-upgrade",{scene:this.scene,x:this.x,y:this.y+300*_TD.retina,is_visiable:!1,text:a._t("button_upgrade_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToUpgrade(this)}});this.btn_sell=new a.Button("panel-btn-sell",{scene:this.scene,x:this.x,y:this.y+340*_TD.retina,is_visiable:!1,text:a._t("button_sell_text"),
step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToSell(this)}})},step:function(){a.life_recover&&(this._life_recover=this._life_recover2=a.life_recover,this._life_recover_wait=this._life_recover_wait2=3*a.exp_fps,a.life_recover=0);this._life_recover&&0==a.iframe%a.exp_fps_eighth&&(a.life++,this._life_recover--)},render:function(){var b=a.ctx;b.textAlign="left";b.textBaseline="top";b.fillStyle="#000";b.font="normal "+12*_TD.retina+
"px 'Courier New'";b.beginPath();b.fillText(a._t("panel_money_title")+a.money,this.x,this.y);b.fillText(a._t("panel_score_title")+a.score,this.x,this.y+20*_TD.retina);b.fillText(a._t("panel_life_title")+a.life,this.x,this.y+40*_TD.retina);b.fillText(a._t("panel_building_title")+this.map.buildings.length,this.x,this.y+60*_TD.retina);b.fillText(a._t("panel_monster_title")+this.map.monsters.length,this.x,this.y+80*_TD.retina);b.fillText(a._t("wave_info",[this.scene.wave]),this.x,this.y+210*_TD.retina);
b.closePath();this._life_recover_wait&&(b.fillStyle="rgba(255, 0, 0, "+this._life_recover_wait/this._life_recover_wait2+")",b.font="bold "+12*_TD.retina+"px 'Verdana'",b.beginPath(),b.fillText("+"+this._life_recover2,this.x+60*_TD.retina,this.y+40*_TD.retina),b.closePath(),this._life_recover_wait--);b.textAlign="right";b.fillStyle="#666";b.font="normal "+12*_TD.retina+"px 'Courier New'";b.beginPath();b.fillText("version: "+a.version+" | oldj.net",a.stage.width-a.padding,a.stage.height-2*a.padding);
b.closePath();b.textAlign="left";b.fillStyle="#666";b.font="normal "+12*_TD.retina+"px 'Courier New'";b.beginPath();b.fillText("FPS: "+a.fps,a.padding,a.stage.height-2*a.padding);b.closePath()}};a.Panel=function(b,d){var c=new a.Element(b,d);a.lang.mix(c,e);c._init(d);return c};var c={_init:function(b){b=b||{};this.scene=b.scene},caculatePos:function(){var b=this.el;this.x=b.cx+.5;this.y=b.cy+.5;this.x+this.width>this.scene.stage.width-a.padding&&(this.x-=this.width);this.px=this.x+5*_TD.retina;this.py=
this.y+4*_TD.retina},msg:function(b,d){this.text=b;var c=a.ctx;c.font="normal "+12*_TD.retina+"px 'Courier New'";this.width=Math.max(c.measureText(b).width+10*_TD.retina,6*a.lang.strLen2(b)+10*_TD.retina);this.height=20*_TD.retina;d&&d.cx&&d.cy&&(this.el=d,this.caculatePos(),this.show())},step:function(){this.el&&this.el.is_valid?this.el.is_monster&&this.caculatePos():this.hide()},render:function(){if(this.el){var b=a.ctx;b.lineWidth=_TD.retina;b.fillStyle="rgba(255, 255, 0, 0.5)";b.strokeStyle="rgba(222, 222, 0, 0.9)";
b.beginPath();b.rect(this.x,this.y,this.width,this.height);b.closePath();b.fill();b.stroke();b.textAlign="left";b.textBaseline="top";b.fillStyle="#000";b.font="normal "+12*_TD.retina+"px 'Courier New'";b.beginPath();b.fillText(this.text,this.px,this.py);b.closePath()}}};a.BalloonTip=function(b,d){var e=new a.Element(b,d);a.lang.mix(e,c);e._init(d);return e};var b={_init:function(b){b=b||{};this.text=b.text;this.onClick=b.onClick||a.lang.nullFunc;this.x=b.x;this.y=b.y;this.width=b.width||80*_TD.retina;
this.height=b.height||30*_TD.retina;this.font_x=this.x+8*_TD.retina;this.font_y=this.y+9*_TD.retina;this.scene=b.scene;this.desc=b.desc||"";this.addToScene(this.scene,this.step_level,this.render_level);this.caculatePos()},onEnter:function(){a.mouseHand(!0);this.desc&&this.scene.panel.balloontip.msg(this.desc,this)},onOut:function(){a.mouseHand(!1);this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},render:function(){var b=a.ctx;b.lineWidth=2*_TD.retina;b.fillStyle=this.is_hover?
"#eee":"#ccc";b.strokeStyle="#999";b.beginPath();b.rect(this.x,this.y,this.width,this.height);b.closePath();b.fill();b.stroke();b.textAlign="left";b.textBaseline="top";b.fillStyle="#000";b.font="normal "+12*_TD.retina+"px 'Courier New'";b.beginPath();b.fillText(this.text,this.font_x,this.font_y);b.closePath();b.fill()}};a.Button=function(d,c){c.on_events=["enter","out","click"];var e=new a.Element(d,c);a.lang.mix(e,b);e._init(c);return e};var d={_init:function(b){this.panel=b.panel;this.scene=b.scene;
this.addToScene(this.scene,1,9)},render:function(){this.panel.btn_pause.hide();this.panel.btn_upgrade.hide();this.panel.btn_sell.hide();this.panel.btn_restart.show();var b=a.ctx;b.textAlign="center";b.textBaseline="middle";b.fillStyle="#ccc";b.font="bold 62px 'Verdana'";b.beginPath();b.fillText("GAME OVER",this.width/2,this.height/2);b.closePath();b.fillStyle="#f00";b.font="bold 60px 'Verdana'";b.beginPath();b.fillText("GAME OVER",this.width/2,this.height/2);b.closePath()}};a.GameOver=function(b,
c){var e=new a.Element(b,c);a.lang.mix(e,d);e._init(c);return e};a.recover=function(b){a.life_recover=b;a.log("life recover: "+b)}});
_TD.a.push(function(a){var e=function(){var b=new a.Act(this,"act-1"),b=new a.Scene(b,"scene-1"),d=a.getDefaultStageData("scene_endless");this.config=d.config;a.life=this.config.life;a.money=this.config.money;a.score=this.config.score;a.difficulty=this.config.difficulty;a.wave_damage=this.config.wave_damage;var c=new a.Map("main-map",a.lang.mix({scene:b,is_main_map:!0,step_level:1,render_level:2},d.map));c.addToScene(b,1,2,c.grids);b.map=c;b.panel=new a.Panel("panel",a.lang.mix({scene:b,main_map:c,
step_level:1,render_level:7},d.panel));this.newWave=d.newWave;this.map=c;this.wait_new_wave=this.config.wait_new_wave},c=function(){var b=this.current_act.current_scene,d=b.wave;if((0!=d||this.map.has_weapon)&&1==b.state&&0==this.map.monsters.length){if(0<d&&this.wait_new_wave==this.config.wait_new_wave-1){var c=0;0==d%10?c=10:0==d%5&&(c=5);100<a.life+c&&(c=100-a.life);0<c&&a.recover(c)}0<this.wait_new_wave?this.wait_new_wave--:(this.wait_new_wave=this.config.wait_new_wave,d++,b.wave=d,this.newWave({map:this.map,
wave:d}))}};a.getDefaultStageData=function(b){return{stage_main:{width:640*_TD.retina,height:560*_TD.retina,init:e,step2:c},scene_endless:{map:{grid_x:16,grid_y:16,x:a.padding,y:a.padding,entrance:[0,0],exit:[15,15],grids_cfg:[{pos:[3,3],passable_flag:0},{pos:[7,15],build_flag:0},{pos:[4,12],building:"wall"},{pos:[4,13],building:"wall"}]},panel:{x:2*a.padding+16*a.grid_size,y:a.padding,map:{grid_x:3,grid_y:3,x:0,y:110*_TD.retina,grids_cfg:[{pos:[0,0],building:"cannon"},{pos:[1,0],building:"LMG"},
{pos:[2,0],building:"HMG"},{pos:[0,1],building:"laser_gun"},{pos:[2,2],building:"wall"}]}},config:{endless:!0,wait_new_wave:3*a.exp_fps,difficulty:1,wave:0,max_wave:-1,wave_damage:0,max_monsters_per_wave:100,money:500,score:0,life:100,waves:[[],[[1,0]],[[1,0],[1,1]],[[2,0],[1,1]],[[2,0],[1,1]],[[3,0],[2,1]],[[4,0],[2,1]],[[5,0],[3,1],[1,2]],[[6,0],[4,1],[1,2]],[[7,0],[3,1],[2,2]],[[8,0],[4,1],[3,2]]]},newWave:function(b){b=b||{};var c=b.map;b=b.wave||1;var e=a.wave_damage||0;1!=b&&(0==e?a.difficulty=
5>b?1.05*a.difficulty:30<a.difficulty?1.1*a.difficulty:1.2*a.difficulty:50<=a.wave_damage?a.difficulty*=.6:30<=a.wave_damage?a.difficulty*=.7:20<=a.wave_damage?a.difficulty*=.8:10<=a.wave_damage?a.difficulty*=.9:10<=b&&(a.difficulty*=1.05));1>a.difficulty&&(a.difficulty=1);a.log("wave "+b+", last wave damage = "+e+", difficulty = "+a.difficulty);b=this.config.waves[b]||a.makeMonsters(Math.min(Math.floor(Math.pow(b,1.1)),this.config.max_monsters_per_wave));c.addMonsters2(b);a.wave_damage=0}}}[b]||
{}}});
_TD.a.push(function(a){a.default_upgrade_rule=function(a,c){return 1.2*c};a.getDefaultBuildingAttributes=function(a){return{wall:{damage:0,range:0,speed:0,bullet_speed:0,life:100,shield:500,cost:5},cannon:{damage:12,range:4,max_range:8,speed:2,bullet_speed:6,life:100,shield:100,cost:300,_upgrade_rule_damage:function(a,b){return b*(10>=a?1.2:1.3)}},LMG:{damage:5,range:5,max_range:10,speed:3,bullet_speed:6,life:100,shield:50,cost:100},HMG:{damage:30,range:3,max_range:5,speed:3,bullet_speed:5,life:100,
shield:200,cost:800,_upgrade_rule_damage:function(a,b){return 1.3*b}},laser_gun:{damage:25,range:6,max_range:10,speed:20,life:100,shield:100,cost:2E3}}[a]||{}}});
_TD.a.push(function(a){function e(){if(this.is_valid&&this.grid){var c=a.ctx;c.strokeStyle="#000";c.lineWidth=1;c.fillStyle=this.color;c.beginPath();c.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0);c.closePath();c.fill();c.stroke();if(a.show_monster_life){var b=Math.floor(a.grid_size/4),d=2*b-2*_TD.retina;c.fillStyle="#000";c.beginPath();c.fillRect(this.cx-b,this.cy-this.r-6,2*b,4*_TD.retina);c.closePath();c.fillStyle="#f00";c.beginPath();c.fillRect(this.cx-b+_TD.retina,this.cy-this.r-(6-_TD.retina),
this.life*d/this.life0,2*_TD.retina);c.closePath()}}}a.getDefaultMonsterAttributes=function(c){var b=[{name:"monster 1",desc:"\u6700\u5f31\u5c0f\u7684\u602a\u7269",speed:3,max_speed:10,life:50,damage:1,shield:0,money:5},{name:"monster 2",desc:"\u7a0d\u5f3a\u4e00\u4e9b\u7684\u5c0f\u602a",speed:6,max_speed:20,life:50,damage:2,shield:1},{name:"monster speed",desc:"\u901f\u5ea6\u8f83\u5feb\u7684\u5c0f\u602a",speed:12,max_speed:30,life:50,damage:3,shield:1},{name:"monster life",desc:"\u751f\u547d\u503c\u5f88\u5f3a\u7684\u5c0f\u602a",
speed:5,max_speed:10,life:500,damage:3,shield:1},{name:"monster shield",desc:"\u9632\u5fa1\u5f88\u5f3a\u7684\u5c0f\u602a",speed:5,max_speed:10,life:50,damage:3,shield:20},{name:"monster damage",desc:"\u4f24\u5bb3\u503c\u5f88\u5927\u7684\u5c0f\u602a",speed:7,max_speed:14,life:50,damage:10,shield:2},{name:"monster speed-life",desc:"\u901f\u5ea6\u3001\u751f\u547d\u90fd\u8f83\u9ad8\u7684\u602a\u7269",speed:15,max_speed:30,life:100,damage:3,shield:3},{name:"monster speed-2",desc:"\u901f\u5ea6\u5f88\u5feb\u7684\u602a\u7269",
speed:30,max_speed:40,life:30,damage:4,shield:1},{name:"monster shield-life",desc:"\u9632\u5fa1\u5f88\u5f3a\u3001\u751f\u547d\u503c\u5f88\u9ad8\u7684\u602a\u7269",speed:3,max_speed:10,life:300,damage:5,shield:15}];if("undefined"==typeof c)return b.length;var d={};a.lang.mix(d,b[c]||b[0]);d.render||(d.render=e);return d};a.makeMonsters=function(c,b){var d=[],e=0,h,f,k=a.monster_type_count;if(!b)for(b=[],h=0;h<k;h++)b.push(h);for(;e<c;)h=c-e,h=Math.min(Math.floor(Math.random()*h)+1,3),f=Math.floor(Math.random()*
k),d.push([h,b[f]]),e+=h;return d}});
_TD.a.push(function(a){function e(b,a,c,e,f,k){var l,m,n,p;if(a==e)e=a,f=f>c?c+k:c-k;else if(c==f)f=c,e=e>a?a+k:a-k;else{f=(c-f)/(a-e);l=c-a*f;n=f*f+1;p=2*(f*(l-c)-a);k=Math.pow(l-c,2)+a*a-Math.pow(k,2);k=Math.pow(p,2)-4*n*k;if(0>k)return[0,0];k=Math.sqrt(k);m=(-p+k)/(2*n);e=0<e-a&&0<m-a||0>e-a&&0>m-a?m:(-p-k)/(2*n);f=f*e+l}b.lineCap="round";b.moveTo(a,c);b.lineTo(e,f);return[e,f]}var c={cannon:function(b,a,c,h,f){c=b.getTargetPosition();a.fillStyle="#393";a.strokeStyle="#000";a.beginPath();a.lineWidth=
_TD.retina;a.arc(b.cx,b.cy,f-5,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.lineWidth=3*_TD.retina;a.beginPath();a.moveTo(b.cx,b.cy);b.muzzle=e(a,b.cx,b.cy,c[0],c[1],f);a.closePath();a.stroke();a.lineWidth=_TD.retina;a.fillStyle="#060";a.beginPath();a.arc(b.cx,b.cy,7*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.fillStyle="#cec";a.beginPath();a.arc(b.cx+2,b.cy-2,3*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill()},LMG:function(b,a,c,h,f){c=b.getTargetPosition();a.fillStyle=
"#36f";a.strokeStyle="#000";a.beginPath();a.lineWidth=_TD.retina;a.arc(b.cx,b.cy,7*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.lineWidth=2*_TD.retina;a.beginPath();a.moveTo(b.cx,b.cy);b.muzzle=e(a,b.cx,b.cy,c[0],c[1],f);a.closePath();a.fill();a.stroke();a.lineWidth=_TD.retina;a.fillStyle="#66c";a.beginPath();a.arc(b.cx,b.cy,5*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.fillStyle="#ccf";a.beginPath();a.arc(b.cx+1,b.cy-1,2*_TD.retina,0,2*Math.PI,!0);a.closePath();
a.fill()},HMG:function(b,a,c,h,f){c=b.getTargetPosition();a.fillStyle="#933";a.strokeStyle="#000";a.beginPath();a.lineWidth=_TD.retina;a.arc(b.cx,b.cy,f-2,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.lineWidth=5*_TD.retina;a.beginPath();a.moveTo(b.cx,b.cy);b.muzzle=e(a,b.cx,b.cy,c[0],c[1],f);a.closePath();a.fill();a.stroke();a.lineWidth=_TD.retina;a.fillStyle="#630";a.beginPath();a.arc(b.cx,b.cy,f-5*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.stroke();a.fillStyle="#960";a.beginPath();
a.arc(b.cx+1,b.cy-1,8*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.fillStyle="#fcc";a.beginPath();a.arc(b.cx+3,b.cy-3,4*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill()},wall:function(b,a,c,e,f){a.lineWidth=_TD.retina;a.fillStyle="#666";a.strokeStyle="#000";a.fillRect(b.cx-f+1,b.cy-f+1,e-1,e-1);a.beginPath();a.moveTo(b.cx-f+.5,b.cy-f+.5);a.lineTo(b.cx-f+.5,b.cy+f+.5);a.lineTo(b.cx+f+.5,b.cy+f+.5);a.lineTo(b.cx+f+.5,b.cy-f+.5);a.lineTo(b.cx-f+.5,b.cy-f+.5);a.moveTo(b.cx-f+.5,b.cy+f+.5);a.lineTo(b.cx+
f+.5,b.cy-f+.5);a.moveTo(b.cx-f+.5,b.cy-f+.5);a.lineTo(b.cx+f+.5,b.cy+f+.5);a.closePath();a.stroke()},laser_gun:function(b,a){a.fillStyle="#f00";a.strokeStyle="#000";a.beginPath();a.lineWidth=_TD.retina;a.moveTo(b.cx,b.cy-10*_TD.retina);a.lineTo(b.cx-8.66*_TD.retina,b.cy+5*_TD.retina);a.lineTo(b.cx+8.66*_TD.retina,b.cy+5*_TD.retina);a.lineTo(b.cx,b.cy-10*_TD.retina);a.closePath();a.fill();a.stroke();a.fillStyle="#60f";a.beginPath();a.arc(b.cx,b.cy,7*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();
a.stroke();a.fillStyle="#000";a.beginPath();a.arc(b.cx,b.cy,3*_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.fillStyle="#666";a.beginPath();a.arc(b.cx+1,b.cy-1,_TD.retina,0,2*Math.PI,!0);a.closePath();a.fill();a.lineWidth=3*_TD.retina;a.beginPath();a.moveTo(b.cx,b.cy);a.closePath();a.fill();a.stroke()}};a.renderBuilding=function(b){(c[b.type]||c.wall)(b,a.ctx,b.map,a.grid_size,a.grid_size/2)}});
_TD.a.push(function(a){a._msg_texts={_cant_build:"Can't build here!",_cant_pass:"Can't pass!",entrance:"Entrance",exit:"Exit",not_enough_money:"Not enough money, need $${0}.",wave_info:"Wave ${0}",panel_money_title:"Money: ",panel_score_title:"Score: ",panel_life_title:"Life: ",panel_building_title:"Buildings: ",panel_monster_title:"Monsters: ",building_name_block:"Roadblock",building_name_cannon:"Cannon",building_name_LMG:"LMG",building_name_HMG:"HMG",building_name_laser_gun:"Laser gun",building_info:"${0}: Level ${1}, Damage ${2}, Speed ${3}, Range ${4}, Kill ${5}",
building_info_wall:"${0}",building_intro_wall:"Roadblock: monsters could not pass ($${0})",building_intro_cannon:"Cannon: blance in range and damage ($${0})",building_intro_LMG:"Light Machine Gun: longer range, normal damage ($${0})",building_intro_HMG:"Heavy Machine Gun: fast shoot, greater damage, normal range ($${0})",building_intro_laser_gun:"Laser gun: greater damage, 100% hit ($${0})",click_to_build:"Left click to build ${0} ($${1})",upgrade:"Upgrade ${0} to level ${1} , cost $${2}\u3002",sell:"Sell ${0} for $${1}",
upgrade_success:"Upgrade success! ${0} upgrades to level ${1}. Next upgrade will take $${2}.",monster_info:"Monster: Life ${0}, Shield ${1}, Speed ${2}, Damage ${3}",button_upgrade_text:"Upgrade",button_sell_text:"Sell",button_start_text:"Start",button_restart_text:"Restart",button_pause_text:"Pause",button_continue_text:"Continue",button_pause_desc_0:"Pause the game",button_pause_desc_1:"Resume the game",blocked:"Can't build here, it will block the way from entrance to exit!",monster_be_blocked:"Can't build here, some monster will be blocked!",
entrance_or_exit_be_blocked:"Can't build on the entrance or the exit!",_:"ERROR"};a._t=a.translate=function(a,c){c="object"==typeof c&&c.constructor==Array?c:[];var b=this._msg_texts[a]||this._msg_texts._,d,g=c.length;for(d=0;d<g;d++)b=b.replace("${"+d+"}",c[d]);return b}});
_TD.a.push(function(a){a.FindWay=function(a,c,b,d,g,h,f){this.m=[];this.w=a;this.h=c;this.x1=b;this.y1=d;this.x2=g;this.y2=h;this.way=[];this.len=this.w*this.h;this.is_blocked=this.is_arrived=!1;this.fPassable="function"==typeof f?f:function(){return!0};this._init()};a.FindWay.prototype={_init:function(){if(this.x1==this.x2&&this.y1==this.y2)this.is_arrived=!0,this.way=[[this.x1,this.y1]];else{for(var a=0;a<this.len;a++)this.m[a]=-2;this.x=this.x1;this.y=this.y1;this.distance=0;this.current=[[this.x,
this.y]];for(this.setVal(this.x,this.y,0);this.next(););}},getVal:function(a,c){var b=c*this.w+a;return b<this.len?this.m[b]:-1},setVal:function(a,c,b){a=c*this.w+a;if(a>this.len)return!1;this.m[a]=b},getNeighborsOf:function(a,c){var b=[];0<c&&b.push([a,c-1]);a<this.w-1&&b.push([a+1,c]);c<this.h-1&&b.push([a,c+1]);0<a&&b.push([a-1,c]);return b},getAllNeighbors:function(){var a=[],c,b,d=this.current.length;for(b=0;b<d;b++)c=this.current[b],c=this.getNeighborsOf(c[0],c[1]),a=a.concat(c);return a},findWay:function(){for(var a=
this.x2,c=this.y2,b=this.len,d,g,h,f=-1;(a!=this.x1||c!=this.y1)&&0!=f&&this.way.length<b;){this.way.unshift([a,c]);g=this.getNeighborsOf(a,c);d=g.length;a=[];f=-1;for(h=0;h<d;h++)c=this.getVal(g[h][0],g[h][1]),0>c||!(0>f||f>c)||(f=c);for(h=0;h<d;h++)c=g[h],f==this.getVal(c[0],c[1])&&a.push(c);c=a.length;h=1<c?Math.floor(Math.random()*c):0;c=a[h];a=c[0];c=c[1]}},arrive:function(){this.current=[];this.is_arrived=!0;this.findWay()},blocked:function(){this.current=[];this.is_blocked=!0},next:function(){var a=
this.getAllNeighbors(),c,b=a.length,d=[],g,h,f,k;this.distance++;for(f=0;f<b;f++)if(c=a[f],g=c[0],h=c[1],-2==this.getVal(g,h)&&(this.fPassable(g,h)?(k=this.distance,d.push(c)):k=-1,this.setVal(g,h,k),g==this.x2&&h==this.y2))return this.arrive(),!1;if(0==d.length)return this.blocked(),!1;this.current=d;return!0}}});
